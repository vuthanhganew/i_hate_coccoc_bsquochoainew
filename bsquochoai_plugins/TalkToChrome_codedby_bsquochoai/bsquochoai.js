ulti = {
	lenh: {
		data: {
			"gmail": {action: "moTab("+JSON.stringify({link: 'https://mail.google.com/mail/u/0/#inbox'})+")"},
			"gửi mail": {action: "moTab("+JSON.stringify({link: 'https://mail.google.com/mail/u/0/#inbox'})+")"},
			"facebook": {action: "moTab("+JSON.stringify({link: 'https://facebook.com'})+")"},
			"youtube": {action: "moTab("+JSON.stringify({link: 'https://youtube.com'})+")"},
			"báo tuổi trẻ": {action: "moTab("+JSON.stringify({link: 'http://tuoitre.vn'})+")"},
			"báo 24 giờ": {action: "moTab("+JSON.stringify({link: 'http://www.24h.com.vn'})+")"},
			"học anh văn": {action: "moTab("+JSON.stringify({link: 'http://av.bsquochoai.ga'})+")"},
			"zing mp3": {action: "moTab("+JSON.stringify({link: 'http://mp3.zing.vn'})+")"},
			"youtube của tôi" : {action: "moTab("+JSON.stringify({link: 'https://www.youtube.com/my_videos?o=U'})+")"}
		},
		timkiem: {
			video: "tìm kiếm video",
			hinh: "tìm kiếm hình ảnh",
			map: "tìm kiếm bản đồ"
		},
		chrome: {
			"cài đặt": "settings",
			"phím tắt": "extensions/configureCommands",
			"download": "downloads",
			"tải xuống": "downloads",
			"extension": "extensions",
			"phần mở rộng": "extensions",
			"bút máy": "bookmarks",
			"phiên bản": "chrome",
			"các ứng dụng": "apps",
			"lịch sử": "history"
		},
		moLink: {
			"vẽ đồ thị": "Chromedothi_by_hoai/index.html",
			"máy tính":"Chromemaytinh_by_hoai/index.html",
			"đổi ip": "ChromeVPN_by_hoai/caidat.html"
		},
		mo: ["mở vẽ đồ thị", "mở máy tính", "mở từ điển", "mở màn hình", "mở đổi ip", "mở cửa sổ lên", "mở tập maximize", "mở tập fullscreen", "mở tập trước"],
		xulytab: [
			"tải lại", "tải lại tất cả", "quay lại", "tiến lên", "lưu lại", "lưu lại tất cả", "in", "khóa tập", "mở tab mới đóng", "im lặng"
		],
		hotroduongdan: ["tạo hỗ trợ", "xóa hỗ trợ"], 
		fix: {
			keo: {"kiểu súng" : "kéo xuống", "cá sấu" : "kéo xuống", "cao su" : "kéo xuống", "xuống" : "kéo xuống", "súng" : "kéo xuống", "sống" : "kéo xuống", "số" : "kéo xuống", "sóng" : "kéo xuống", "kiểu số" : "kéo xuống", "kẻ sống" : "kéo xuống", "nếu là anh" : "kéo lên", "áo len" : "kéo lên", "kaolin" : "kéo lên", "cao lên" : "kéo lên", "lan" : "kéo lên", "lên" : "kéo lên", "garen" : "kéo lên", "cao xuống" : "kéo xuống", "kéo súng" : "kéo xuống", "cá vàng": "kéo về", "kể về": "kéo về", "kéo vàng": "kéo về", "theo về": "kéo về", "ceo là": "kéo ra", "cao lan": "kéo lên", "lên trên cùng": "kéo lên cùng", "lan can cầu": "kéo lên cùng", "kéo lên cổ": "kéo lên cùng", "cao dưới cùng": "kéo dưới cùng", "kẹo dừa cùng": "kéo dưới cùng", "cao duy tùng": "kéo dưới cùng", "xuống dưới cùng": "kéo dưới cùng", "keo dùng": "kéo dưới cùng", "zoom in": "kéo vào", "kế vào": "kéo vào", "zhumao": "kéo ra", "phóng to": "kéo vào", "thu nhỏ": "kéo ra", "không phóng": "kéo về"},
			dong: {"đồng hồ bên trái": "đóng hết bên trái", "tổng hợp bên trái": "đóng hết bên trái", "đồng hồ bên phải": "đóng hết bên phải", "tổng hợp bên phải": "đóng hết bên phải", "đóng cửa khẩu": "đóng cửa sổ", "đóng cửa sổ súng":"đóng cửa sổ xuống", "đóng cửa sổ xố":"đóng cửa sổ xuống", "động full màn hình": "đóng full màn hình", "đóng tàu màn hình": "đóng full màn hình", "đóng toàn màn hình": "đóng full màn hình", "động full screen": "đóng full màn hình", "động tập trước": "đóng tập trước", "đóng tập này": "đóng cái này", "động tác này": "đóng cái này"},
			tab: {},
			xulytab: {"quay lại hay":"quay lại 2", "tiến lên hay":"tiến lên 2", "khóa tab": "khóa tập", "hoa tập": "khóa tập", "khóa cặp": "khóa tập", "lưu tập": "lưu lại", "lưu tab": "lưu lại", "mở cái vừa đóng":"mở tab mới đóng"},
			hotroduongdan: {"xã hội chợ": "xóa hỗ trợ", "hoa hậu trần": "xóa hỗ trợ", "không hỗ trợ": "xóa hỗ trợ", "hiện hỗ trợ": "tạo hỗ trợ"},
			mo: {"mở cửa sổ lên":"mở tập maximize", "mở cửa sổ lan":"mở tập maximize", "mở cơ sở lên":"mở tập maximize", "mở toàn màn hình":"mở tập fullscreen", "mở full screen":"mở tập fullscreen", "mở to màn hình":"mở tập fullscreen", "mở full màn hình":"mở tập fullscreen", "mở tab trước": "mở tập trước"}
		},
		moTab: function(data){
			chrome.tabs.create({url: data.link})
		},
		lenhMo: function(lenh){
			cquery = lenh.substring(3)
			if(["từ điển", "màn hình"].indexOf(cquery) != -1){
				chrome.runtime.sendMessage({ham: "talktochrome", type: "mo", lenh: cquery})
			} else if (["tập trước", "tập fullscreen", "tập maximize", "cửa sổ lên"].indexOf(cquery) != -1){
				chrome.runtime.sendMessage({ham: "talktochrome", type: "tab", action: "motab", lenh: cquery})
			}
			else {
				ulti.lenh.moTab({link:  "/bsquochoai_plugins/"+ulti.lenh.moLink[cquery]})
			}
		},
		lenhKeo: function(lenh){
			cquery = lenh.substring(4)
			chrome.runtime.sendMessage({ham: "talktochrome", type: "keo", lenh: cquery})
		},
		lenhMoTab: function(lenh){
			cquery = lenh.substring(6).trim()
			chrome.runtime.sendMessage({ham: "talktochrome", type: "tab", action: "motab", lenh: cquery})
		},
		lenhDongTab: function(lenh){
			cquery = lenh.substring(5)
			chrome.runtime.sendMessage({ham: "talktochrome", type: "tab", action: "dongtab", lenh: cquery})
		}
	}
}
customLenh = {
	caidat: {
		actionmenu: '<div class=bs-actionmenu><i class="bs-icon mdi-content-add-box add" title="Thêm vào bộ lệnh của riêng em"></i><i class="bs-icon mdi-navigation-cancel delete" title="Xóa câu này"></i></div>',
		lenhmenu: '<div class=bs-lenhmenu><i class="bs-icon mdi-content-content-copy copy" title="Sao chép dòng lệnh này"></i><i class="bs-icon mdi-action-visibility-off disable" title="Tạm thời Tắt/Bật dòng lệnh này"></i><i class="bs-icon mdi-navigation-cancel delete" title="Xóa dòng lệnh này ra khỏi bộ nhớ"></i></div>',
		addtemplate: '<tr class="{cclass}"><td><span class=bs-tpl-when>{action_when}</span> <code class=bs-lenh data-editable-bybs data-type=textarea>{lenhtext}</code> sẽ <code class=bs-action data-type=select  data-editable-bybs></code> : <code placeholder="điền vào" data-type="textarea" class=bs-data  data-editable-bybs>{data}</code><span class=bs-tpl-end></span></td></tr>',
		huongdan : {
			noi: "Khi nói",
			thay: "Trong đoạn văn, cụm từ"
		}
	},
	init: function(){
		$.fn.editable.defaults.mode = "inline"
		$.fn.editable.defaults.showbuttons = false
		$.fn.editable.defaults.send = "never"
		$.fn.editable.defaults.onblur = "submit"
		
		$("body").append('<style>.bs-lenhcuaem textarea.form-control{width:'+($(".bs-lenhcuaem").width()-20)+'px}</style>')
		
		customLenh.loadSaved()
		
		$(".bs-lenhcuaem").on({
			 mouseenter: function () {
				if($(this).data("ok") != undefined){
					$(this).find(".bs-lenhmenu").removeClass("hidden")
					return false;
				};
				$(this).append(customLenh.caidat.lenhmenu)
				$(this).data("ok", "1")
			 },
			 mouseleave: function () {
				 $(this).find(".bs-lenhmenu").addClass("hidden")
			 }
		}, "tr");
		
		$(".bs_caclenhdara").on({
			 mouseenter: function () {
				if($(this).data("ok") != undefined){
					$(this).find(".bs-actionmenu").removeClass("hidden")
					return false;
				};
				$(this).append(customLenh.caidat.actionmenu)
				$(this).data("ok", "1")
			 },
			 mouseleave: function () {
				 $(this).find(".bs-actionmenu").addClass("hidden")
			 }
		}, "p");
		
		$(".bs_caclenhdara").on("click", ".bs-actionmenu .add", function(){
			lenhtext = $(this).parent().parent().text()
			customLenh.add({lenh: lenhtext})
		})
		$(".bs_caclenhdara").on("click", ".bs-actionmenu .delete", function(){
			$(this).parent().parent().remove()
		})
		$(".bs-lenhcuaem").on("click", ".bs-lenhmenu .copy", function(){
			who = $(this).closest( "tr" )
			who.after(who.prop("outerHTML"))
			customLenh.add_initEditable(who.find(".bs-action").editable('getValue', true))
			customLenh.saveAll()
		})
		$(".bs-lenhcuaem").on("click", ".bs-lenhmenu .disable", function(){
			who = $(this).closest( "tr" )
			who.toggleClass("bs-disable")
			customLenh.saveAll()
		})
		$(".bs-lenhcuaem").on("click", ".bs-lenhmenu .delete", function(){
			$(this).closest( "tr" ).remove()
			customLenh.saveAll()
		})
		
	},
	add: function(dulieu){
		action = dulieu.action || "mo"
		data = dulieu.data || "nhấp để sửa"
		lenhtext = dulieu.lenh
		isDisable = dulieu.isDisable || false
		
		if(action == "thaydoi"){
			action_when = customLenh.caidat.huongdan.thay
		} else action_when = customLenh.caidat.huongdan.noi
		
		contain = $(".bs-lenhcuaem tbody")
		if(isDisable) cclass = "bs-disable"
		else cclass = ''
		contain.prepend(customLenh.caidat.addtemplate.replace(/{lenhtext}/g, lenhtext).replace(/{data}/g, data).replace(/{action_when}/g, action_when).replace(/{cclass}/g, cclass))
		
		customLenh.add_initEditable(action)
		customLenh.saveAll()
	},
	add_initEditable: function(action){
		$('[data-editable-bybs]').on('init', function(e, params) {
			 $(this).on('hidden', function(e, reason) {
					if(["save"].indexOf(reason) != -1){
						customLenh.saveAll()
						action = $(this).parent().find(".bs-action").editable('getValue', true)
						if(action == "thaydoi"){
							$(this).parent().find(".bs-tpl-when").text(customLenh.caidat.huongdan.thay)
						} else {
							$(this).parent().find(".bs-tpl-when").text(customLenh.caidat.huongdan.noi)
						}
					}
			});
		});
		$('.bs-data, .bs-lenh').editable({rows: 2});
		$('.bs-action').editable({
			value: action,
        source: [
              {value: "thuchienlenh", text: 'thực hiện lệnh'},
              {value: "mo", text: 'mở các trang'},
              {value: "thaydoi", text: 'được thay bằng'}
           ]
		});
	},
	saveAll: function(){
		data = {bs_talktochrome_customLenh: []}
		$.each($(".bs-lenhcuaem tr"), function(){
			data.bs_talktochrome_customLenh.push({
				lenh: $(this).find(".bs-lenh").editable('getValue', true),
				action: $(this).find(".bs-action").editable('getValue', true),
				data:  $(this).find(".bs-data").editable('getValue', true),
				isDisable: $(this).hasClass('bs-disable')
			})
		})
		chrome.storage.local.set(data, function(){
			customLenh.updateCurrentData()
		})
	},
	loadSaved: function(){
		chrome.storage.local.get("bs_talktochrome_customLenh", function(re){
			if(typeof re.bs_talktochrome_customLenh == "undefined"){
				//Not have any
				return false;
			}
			for(i=re.bs_talktochrome_customLenh.length-1; i>=0; i--){
				customLenh.add(re.bs_talktochrome_customLenh[i])
			}
		})
	},
	updateCurrentData: function(){
		chrome.storage.local.get(["bs_talktochrome_customLenh"], function(dataTTC){
			mylenh = {mo: {}, thaydoi: {}, thuchienlenh: {}}
			customLenh.xulymylenh(dataTTC.bs_talktochrome_customLenh)
		})
	},
	xulymylenh: function(bs_talktochrome_customLenh){
		$.each(bs_talktochrome_customLenh, function(ind, val){
			if(!val.isDisable){
				if(val.lenh.indexOf(",") != -1){
					lenh2 = val.lenh.split(",")
					$.each(lenh2, function(i2, v2){
						mylenh[val.action][v2.trim()] = val.data
					})
				} else {
					mylenh[val.action][val.lenh] = val.data
				}
			}
		})
		customLenh.setupLenhThaydoi()
	},
	setupLenhThaydoi: function(){
		//******* mylenhReplaceReg
		if (Object.keys(mylenh.thaydoi).length == 0) return false;
		window.mylenhThaydoiReg = new String("(")
		$.each(mylenh.thaydoi, function(k, v){
			mylenhThaydoiReg += k+"|" 
		})
		mylenhThaydoiReg = mylenhThaydoiReg.substring(0, mylenhThaydoiReg.length - 1)+")"
		mylenhThaydoiReg = new RegExp(mylenhThaydoiReg, "g")
	}
}
$(function(){
	init() // Cài đặt trang hiện tại
	chrome.storage.local.get(["bs_talktochrome","bs_talktochrome_customLenh"], function(dataTTC){
		mylenh = {mo: {}, thaydoi: {}, thuchienlenh: {}}
		if(typeof dataTTC.bs_talktochrome_customLenh != "undefined")
		customLenh.xulymylenh(dataTTC.bs_talktochrome_customLenh)
		
		sound(dataTTC.bs_talktochrome.caidat)
	})
	customLenh.init()
})
function init(){
	ngonngumacdinh = "vi-VN"
	//Chọn ngôn ngữ
	ngonngu = [
		{t: "Tiếng Việt", v: "vi-VN"},
		{t: "English", v:"en-US"}
	]
	$.each(ngonngu, function(k,v){
		$("#cd-ngonngu").append('<option value="'+v.v+'">'+v.t+' ('+v.v+')</option>')
	})
	//Cài đặt các giá trị cài đặt mặc định
	chrome.storage.local.get("bs_talktochrome", function(re){
		if(typeof re.bs_talktochrome == "undefined"){
			re.bs_talktochrome = {caidat: {ngonngu: ngonngumacdinh, tukhoidong: true}};
			chrome.storage.local.set(re)
		}
		$('[data-caidat-select]').each(function(){
			$(this).val(re.bs_talktochrome.caidat.ngonngu)
		})
		$('[data-caidat-checkbox]').each(function(){
			$(this).prop('checked', re.bs_talktochrome.caidat.tukhoidong)
		})
	})
	//Cài đặt các thay đổi
	$('[data-caidat-select]').change(function(){
		thisLocalStorage = $(this).data("caidat-select")
		thisPointer = $(this).data("caidat-pointer")
		thisValue = $(this).val()
		chrome.storage.local.get("bs_talktochrome", function(re){
			re.bs_talktochrome.caidat[thisLocalStorage] = thisValue
			chrome.storage.local.set(re, function(){
				if(thisLocalStorage == "ngonngu") window.location.reload()
			})
		})
	})
	$('[data-caidat-checkbox]').change(function(){
		thisLocalStorage = $(this).data("caidat-checkbox")
		thisPointer = $(this).data("caidat-pointer")
		thisValue = $(this).prop("checked")
		chrome.storage.local.get("bs_talktochrome", function(re){
			re.bs_talktochrome.caidat[thisLocalStorage] = thisValue
			chrome.storage.local.set(re, function(){})
		})
	})
}
function sound(caidat){
	var recognition = new webkitSpeechRecognition();
	recognition.continuous = false ;
	recognition.interimResults = true;
	recognition.lang = caidat.ngonngu
	recognition.onresult = function(event) {
    var interim_transcript = '';
	 final_transcript = ""
    if (typeof(event.results) == 'undefined') {
      recognition.onend = null;
      recognition.stop();
      return;
    }
    for (var i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        final_transcript += event.results[i][0].transcript;
      } else {
        interim_transcript += event.results[i][0].transcript;
      }
    }
	 if(interim_transcript != "")$(".bs_interim").html(interim_transcript)
    if (final_transcript != "") {
		final_transcript = final_transcript_customlenh(final_transcript); //@@ custom lệnh
		if(final_transcript == "ooo_ket_thuc_o_day_ooo"){
			return false;
		}
		nhanlenh(final_transcript);
      $(".bs_caclenhdara").prepend('<p>'+xulytext(final_transcript)+'</p>')
		$(".bs_interim").html('<b><a target="_blank" href="http://www.bsquochoai.ga/talktochrome">Nhấp để xem hướng dẫn sử dụng và giải nghĩa rõ các lệnh</a></b>')
		window.recognition.abort()
    }
  };
	window.recognition = recognition
  window.recognition.onend = function(){
		window.recognition.start()
  }
  window.recognition.onstart = function(){
  }
	window.recognition.start()
}

function final_transcript_customlenh(ft){
	if (typeof mylenh.thuchienlenh[ft] != "undefined") ft = mylenh.thuchienlenh[ft]
	if (typeof mylenh.mo[ft] != "undefined"){
		allLink = mylenh.mo[ft]
										.replace(/(\(.*\)|\[.*\]|\{.*\}|\n)/g, "")
										.split(",")
		$.each(allLink, function(i2,vava){
			if(vava.trim()!="")
			chrome.tabs.create({url: vava.trim()})
		})
		ft = "ooo_ket_thuc_o_day_ooo"
	}
	return ft;
}

function nhanlenh(lenh){
		lenh = lenh.trim().toLowerCase()
		if(typeof ulti.lenh.data[lenh] != "undefined"){
			action = ulti.lenh.data[lenh].action
			cfunc = action.replace(/\(.*\)/g, "")
			cbien = action.match(/\(.*\)/g)[0].replace(/(\(|\))/g, "")
			window.ulti.lenh[cfunc](JSON.parse(cbien))
		} else if (lenh.match(/^((\d+\s+.*)|(mở \d+\s.*)|(số \d+\s.*))/g)){
			link = lenh.match(/((\d+)|(mở \d+)|(số \d+))/)[0].replace(/(mở|số) /)
			console.log(link)
			lenh = lenh.replace(/((\d+)|(mở \d+)|(số \d+))\s/, "")
			chrome.runtime.sendMessage({ham: "talktochrome", type: "hotroduongdan", action: "writetext", lenh: xulytext(lenh), link: link})
		} else if (lenh.substring(0,3) == "tìm"){
			gquery = lenh.substring(4)
			ulti.lenh.moTab({link:  'https://www.google.com/search?q='+encodeURIComponent(gquery)+'&rct=j&ref=bsquochoainew'})
		}  else if (lenh.substring(lenh.length - 8) == "tìm kiếm"){
			gquery = lenh.substring(0, lenh.length - 9)
			ulti.lenh.moTab({link:  'https://www.google.com/search?q='+encodeURIComponent(gquery)+'&rct=j&ref=bsquochoainew'})
		}  else if (lenh.substring(lenh.length - ulti.lenh.timkiem.video.length) == ulti.lenh.timkiem.video){
			gquery = lenh.substring(0, lenh.length - ulti.lenh.timkiem.video.length - 1)
			ulti.lenh.moTab({link:  'https://www.google.com/search?q='+encodeURIComponent(gquery)+"&tbm=vid&ref=bsquochoainew"})
		}  else if (lenh.substring(lenh.length - ulti.lenh.timkiem.hinh.length) == ulti.lenh.timkiem.hinh){
			gquery = lenh.substring(0, lenh.length - ulti.lenh.timkiem.hinh.length - 1)
			ulti.lenh.moTab({link:  'https://www.google.com/search?q='+encodeURIComponent(gquery)+"&tbm=isch&ref=bsquochoainew"})
		}  else if (lenh.substring(lenh.length - ulti.lenh.timkiem.map.length) == ulti.lenh.timkiem.map){
			gquery = lenh.substring(0, lenh.length - ulti.lenh.timkiem.map.length - 1)
			ulti.lenh.moTab({link:  'https://www.google.com/maps/place/'+encodeURIComponent(gquery)+"/"})
		} else if (lenh.indexOf("cờ rôm") == 0 || lenh.indexOf("rom") == 0 || lenh.indexOf("chrome") == 0 || lenh.indexOf("crom") == 0){
			cquery = lenh.replace("cờ rôm", "").replace("chrome", "").replace("rom", "").replace("crom", "").trim()
			if (typeof ulti.lenh.chrome[cquery] != "undefined")
			ulti.lenh.moTab({link:  "chrome://"+ulti.lenh.chrome[cquery]})
		} else if (ulti.lenh.mo.indexOf(lenh) != -1 || ulti.lenh.fix.mo.hasOwnProperty(lenh)){
			if(ulti.lenh.fix.mo.hasOwnProperty(lenh)) lenh = ulti.lenh.fix.mo[lenh];
			ulti.lenh.lenhMo(lenh)
		} else if (lenh.match(/mở\s(tab|tập|tap|tạp)\s(\d|hay)/g)){
				ulti.lenh.lenhMoTab(lenh)
		} else if (lenh.match(/mở\s(tab|tập|tap|tạp)\smới\sđóng\s(\d|hay)/g)){
			lenh = lenh.replace(/mở\s(tab|tập|tap|tạp)\smới\sđóng\s/g, "")
			if(lenh == "hay"){lenh = 2} else {lenh = Number(lenh)}
			chrome.runtime.sendMessage({ham: "talktochrome", type: "tab", action: "xulytab-tabmoidongdigit", lenh: lenh})
		}  else if (lenh.match(/mở\s(\d|hay)\s(tab|tập|tap|tạp)\smới\sđóng/g)){
			lenh = lenh.replace(/(mở\s|(tab|tập|tap|tạp)\smới\sđóng)/g, "")
			if(lenh == "hay"){lenh = 2} else {lenh = Number(lenh)}
			chrome.runtime.sendMessage({ham: "talktochrome", type: "tab", action: "xulytab-digittabmoidong", lenh: lenh})
		}  else if (lenh.match(/^(mở\s(hay|\d)|(hay|\d)|số (hay|\d))/g)){
			lenh = lenh.replace(/(mở|số)\s/g, "")
			if(lenh == "hay"){lenh = 2} else {lenh = Number(lenh.replace(/\s/g, ""))}
			chrome.runtime.sendMessage({ham: "talktochrome", type: "hotroduongdan", action: "openlink", lenh: lenh})
		} else if (["kéo"].indexOf(lenh.substring(0,3)) == 0 || ulti.lenh.fix.keo.hasOwnProperty(lenh)){
			if(ulti.lenh.fix.keo.hasOwnProperty(lenh)) lenh = ulti.lenh.fix.keo[lenh];
			ulti.lenh.lenhKeo(lenh)
		} else if (["đóng"].indexOf(lenh.substring(0,4)) == 0 || ulti.lenh.fix.dong.hasOwnProperty(lenh)){
			if(ulti.lenh.fix.dong.hasOwnProperty(lenh)) lenh = ulti.lenh.fix.dong[lenh];
			ulti.lenh.lenhDongTab(lenh)
		} else if (ulti.lenh.xulytab.indexOf(lenh) != -1  || ulti.lenh.fix.xulytab.hasOwnProperty(lenh)){
			if(ulti.lenh.fix.xulytab.hasOwnProperty(lenh)) lenh = ulti.lenh.fix.xulytab[lenh];
			chrome.runtime.sendMessage({ham: "talktochrome", type: "tab", action: "xulytab", lenh: lenh})
		} else if (ulti.lenh.hotroduongdan.indexOf(lenh) != -1  || ulti.lenh.fix.hotroduongdan.hasOwnProperty(lenh)){
			if(ulti.lenh.fix.hotroduongdan.hasOwnProperty(lenh)) lenh = ulti.lenh.fix.hotroduongdan[lenh];
			chrome.runtime.sendMessage({ham: "talktochrome", type: "hotroduongdan", action: "caidat", lenh: lenh})
		} else if (lenh.match(/quay\slại\s(\d|hay)/g)){
			if(ulti.lenh.fix.xulytab.hasOwnProperty(lenh)) lenh = ulti.lenh.fix.xulytab[lenh];
			chrome.runtime.sendMessage({ham: "talktochrome", type: "tab", action: "xulytab-quaylaidigit", lenh: lenh})
		} else if (lenh.match(/tiến\slên\s(\d|hay)/g)){
			if(ulti.lenh.fix.xulytab.hasOwnProperty(lenh)) lenh = ulti.lenh.fix.xulytab[lenh];
			chrome.runtime.sendMessage({ham: "talktochrome", type: "tab", action: "xulytab-tienlendigit", lenh: lenh})
		}
}
dauReplace = {
	"chấm phẩy" : ";",
	"chấm phảy" : ";",
	"hai chấm" : ":",
	"chấm than" : "!",
	"chấm cảm" : "!",
	"chấm hỏi" : "?",
	"phảy" : ",",
	"phẩy" : ",",
	"chấm" : ".",
	"thăng" : "#",
	"đô la" : "$",
	"đôla" : "$",
	"và": "&",
	"mở ngoặc" : "(",
	"đóng ngoặc" : ")",
	"mở ngoặc vuông" : "[",
	"đóng ngoặc vuông" : "]",
	"mở ngoặc móc" : "{",
	"đóng ngoặc móc" : "}",
	"mở ngoặc nhọn" : "{",
	"đóng ngoặc nhọn" : "}"
}
iconReplace = {
	"nhăn mặt" : ":(",
	"le lưỡi" : ":(",
	"cười to" : "=D ",
	"ngạc nhiên" : ":o",
	"nháy mắt" : ";)",
	"kính" : "8-)",
	"kính mát" : "B|",
	"nhau mày" : ">:(",
	"không chắc" : ":/",
	"khóc" : ":'(",
	"thiên thần" : "O:)",
	"hôn" : ":*",
	"hun" : ":*",
	"cười nhiều mặt" : "^_^",
	"loạn hết cả lên" : "o.O",
	"loạn" : "o.O",
	"loạn hết cả lên 2" : "O.o",
	"loạn 2" : "O.o",
	"môi xoăn" : ":3",
	"môi trong" : ":3",
	"buồn" : ">:o",
	"cười vật vã" : ":v",
	"cục cứt" : ":poop:",
	"robot" : ":|]",
	"cười" : ":)"
}
/* iconReplace = {
	"cười 2" : "😃",
	"nhăn mặt" : ":(",
	"le lưỡi" : ":(",
	"cười to" : "=D ",
	"cười to 2" : "😄",
	"cười nhăn răng" : "😤",
	"cười nhắm mắt" : "😆",
	"ngạc nhiên" : ":o",
	"nháy mắt" : ";)",
	"nháy mắt 2" : "😉",
	"kính" : "8-)",
	"kính mát" : "B|",
	"nhau mày" : ">:(",
	"không chắc" : ":/",
	"khóc" : ":'(",
	"khóc 2" : "😢",
	"khóc to" : "😭",
	"thiên thần" : "O:)",
	"hôn" : ":*",
	"hun" : ":*",
	"hôn 2" : "😘",
	"hun 2" : "😘",
	"hôn 3" : "😚",
	"hun 3" : "😚",
	"cười nhiều mặt" : "^_^",
	"loạn hết cả lên" : "o.O",
	"loạn" : "o.O",
	"loạn hết cả lên 2" : "O.o",
	"loạn 2" : "O.o",
	"môi xoăn" : ":3",
	"môi trong" : ":3",
	"buồn" : ">:o",
	"cười vật vã" : ":v",
	"đỏ mặt" : "😊",
	"đỏ mặt 2" : "☺",
	"yêu rồi" : "😍",
	"chọc quê" : "😜",
	"chọc quê 2" : "😝",
	"sốc" : "😳",
	"shock" : "😳",
	"cười nham nhở" : "😁",
	"mặt buồn" : "😔",
	"hài lòng" : "😌",
	"không dễ lừa anh đâu" : "😒",
	"không dễ lừa" : "😒",
	"thất vọng" : "😞",
	"không thay đổi" : "😣",
	"cười chảy nước mắt" : "😂",
	"đang ngủ" : "😪",
	"nhẹ nhõm" : "😥",
	"sợ hãi" : "😰",
	"sợ" : "😨",
	"sợ hét lên" : "😱",
	"đổ mồ hôi lạnh" : "😓",
	"chán" : "😩",
	"mệt" : "😫",
	"giận" : "😠",
	"khùng rồi" : "😡",
	"khùng" : "😡",
	"xấu hổ" : "😖",
	"bác sĩ" : "😷",
	"chóng mặt" : "😵",
	"kinh ngạc" : "😲",
	"cười giả dối" : "😏",
	"ông già noel" : "🎅",
	"cục cứt" : ":poop:",
	"robot" : ":|]",
	"cười" : ":)"
} */
/*http://www.mogicons.com/en/
cười nhiều mặt: đọc cười nhíu mắt
cười môi trong: đọc môi cong
	"ông già noel" : "🎅", ai cần ông già nô el
*/
//******* dauReg
dauStart = "(dấu|đấu)\\s"
dauStartReg = new RegExp(dauStart, "g")
dauReg = dauStart+'('
$.each(dauReplace, function(k, v){
	dauReg += k+"|" 
})
dauReg = dauReg.substring(0, dauReg.length - 1)+")"
dauReg = new RegExp(dauReg, "g")
//******* iconReg
iconStart = '(hình|icon|icons|ai cần|ai cân)\\s'
iconStartReg = new RegExp(iconStart, "g")
iconReg = iconStart+'('
$.each(iconReplace, function(k, v){
	iconReg += k+"|" 
})
iconReg = iconReg.substring(0, iconReg.length - 1)+")"
iconReg = new RegExp(iconReg, "g")

//******* customLenhReg
function xulytext(text){
	text = text.replace(window.mylenhThaydoiReg, function re(m){
		return mylenh.thaydoi[m]
	})
	text = text.replace(dauReg, function re(m){
		keyy = m.replace(dauStartReg, "");
		return dauReplace[keyy]
	})
	text = text.replace(iconReg, function re(m){
		keyy = m.replace(iconStartReg, "");
		return iconReplace[keyy]
	})
	return text;
}


